<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå°Ô∏è √âvolution des temp√©ratures (1880 ‚Üí 2025)</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body {
      background: radial-gradient(circle at center, #0d1117, #000);
      color: white;
      font-family: 'Inter', sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #chart {
      width: 95%;
      height: 80vh;
      margin: auto;
    }
  </style>
</head>

<body>
  <h1>üåç Anomalies mensuelles de temp√©rature (1880 ‚Üí 2025)</h1>
  <p style="color:#ccc;">Source : NASA GISTEMP ‚Äì Temp√©ratures Terre + Oc√©an</p>
  <div id="chart"></div>

  <script>
  async function drawHistogram() {
    // üîπ Lecture locale du CSV (dossier /data)
    const url = "../data/GLB.Ts+dSST.csv";
    const response = await fetch(url);
    const text = await response.text();

    // üîπ Extraction des lignes correspondant √† une ann√©e
    const lines = text.split("\n").filter(l => /^\d{4}/.test(l));
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    const labels = [];
    const values = [];

    for (const line of lines) {
      const cols = line.split(",");
      const year = parseInt(cols[0]);
      for (let i = 1; i <= 12; i++) {
        const val = parseFloat(cols[i]);
        if (!isNaN(val)) {
          labels.push(`${year}-${months[i - 1]}`);
          values.push(val);
        }
      }
    }

    console.log("‚úÖ Donn√©es charg√©es :", labels.length, "points");

    // üîπ Param√®tres de la fen√™tre anim√©e
    const windowSize = 50; // nombre de barres affich√©es simultan√©ment
    let current = 0;

    // üîπ Axe fixe sur toute la p√©riode
    const layout = {
      paper_bgcolor: "#0d1117",
      plot_bgcolor: "#0d1117",
      font: { color: "#fff" },
      margin: { t: 60, b: 80 },
      yaxis: { title: "Anomalie (¬∞C)", range: [-2, 2] },
      xaxis: {
        title: "Ann√©e",
        range: [0, labels.length],
        tickangle: -45,
        showgrid: false,
        showline: false
      },
      title: {
        text: `üå°Ô∏è √âvolution des anomalies de temp√©rature (Fen√™tre de ${windowSize} mois)`,
        font: { size: 18 }
      },
      transition: { duration: 0 }
    };

    // üîπ Premier affichage vide
    const trace = {
      x: [],
      y: [],
      type: "bar",
      marker: { color: [] }
    };

    Plotly.newPlot("chart", [trace], layout, { responsive: true });

    // üîπ Animation progressive
    const totalFrames = labels.length - windowSize;
    function animateStep() {
      const start = current;
      const end = current + windowSize;

      const x = labels.map((_, i) => i); // positions fixes
      const y = new Array(labels.length).fill(null); // on vide tout
      const colors = new Array(labels.length).fill("rgba(255,255,255,0)");

      // on ne remplit que la zone active
      for (let i = start; i < end; i++) {
        y[i] = values[i];
        colors[i] = values[i] >= 0
          ? "rgba(255,90,60,0.9)"
          : "rgba(80,130,255,0.9)";
      }

      Plotly.animate(
        "chart",
        { data: [{ x, y, marker: { color: colors } }] },
        {
          transition: { duration: 100, easing: "linear" },
          frame: { duration: 100, redraw: false }
        }
      );

      current = (current + 1) % totalFrames;
    }

    // Lancement de l‚Äôanimation
    setInterval(animateStep, 100);
  }

  window.addEventListener("load", drawHistogram);
  </script>
</body>
</html>
