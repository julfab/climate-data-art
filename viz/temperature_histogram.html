<script>
async function drawHistogram() {
  const url = "../data/GLB.Ts+dSST.csv";
  const response = await fetch(url);
  const text = await response.text();

  const lines = text.split("\n").filter(l => /^\d{4}/.test(l));
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  const labels = [];
  const values = [];

  for (const line of lines) {
    const cols = line.split(",");
    const year = cols[0];
    for (let i = 1; i <= 12; i++) {
      const val = parseFloat(cols[i]);
      if (!isNaN(val)) {
        labels.push(`${year}-${months[i - 1]}`);
        values.push(val);
      }
    }
  }

  console.log("✅ Données chargées:", labels.length, "points");

  // === paramètres de la fenêtre glissante ===
  const windowSize = 50;
  let current = 0;

  // === graphique initial ===
  const trace = {
    x: labels.slice(0, windowSize),
    y: values.slice(0, windowSize),
    type: "bar",
    marker: {
      color: values.slice(0, windowSize).map(v =>
        v >= 0 ? "rgba(255, 90, 60, 0.85)" : "rgba(80, 130, 255, 0.85)"
      )
    }
  };

  const layout = {
    paper_bgcolor: "#0d1117",
    plot_bgcolor: "#0d1117",
    font: { color: "#fff" },
    margin: { t: 60, b: 50 },
    yaxis: { title: "Anomalie (°C)", range: [-2, 2] },
    xaxis: {
      title: "Date",
      range: [labels[0], labels[labels.length - 1]], // 🌍 axe temporel fixe
      tickangle: -45
    },
    title: {
      text: `🌍 Températures mensuelles (Fenêtre de ${windowSize} mois)`,
      font: { size: 18 }
    }
  };

  Plotly.newPlot("chart", [trace], layout, { responsive: true });

  // === animation fenêtre glissante ===
  setInterval(() => {
    current = (current + 1) % (labels.length - windowSize);
    const x = labels.slice(current, current + windowSize);
    const y = values.slice(current, current + windowSize);
    const colors = y.map(v =>
      v >= 0 ? "rgba(255, 90, 60, 0.85)" : "rgba(80, 130, 255, 0.85)"
    );

    Plotly.animate(
      "chart",
      { data: [{ x, y, marker: { color: colors } }] },
      {
        transition: { duration: 200, easing: "linear" },
        frame: { duration: 200, redraw: false }
      }
    );
  }, 200);
}

drawHistogram();
</script>
